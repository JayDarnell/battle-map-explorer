/*
battle-map-explorer version 1.1

This code is released into the public domain - attribution is appreciated but not required.
Made by Byron Knoll.

https://github.com/byronknoll/battle-map-explorer
*/

window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(D,m){window.setTimeout(D,1E3/60)}}();function BattleMapExplorer(){}
BattleMapExplorer.run=function(D,m,K,E,v){function L(a){return 87==a||38==a||104==a?!0:!1}function M(a){return 65==a||37==a||100==a?!0:!1}function N(a){return 68==a||39==a||102==a?!0:!1}function O(a){return 83==a||40==a||98==a?!0:!1}function x(a,b){for(var c=0;c<segments.length-F;++c)if(VisibilityPolygon.doLineSegmentsIntersect(h,k,a,b,segments[c][0][0],segments[c][0][1],segments[c][1][0],segments[c][1][1]))return;h=a;k=b;f=!0}function P(){var a=canvas.getContext("2d");if(!Q){if(R){Q=!0;var b=q.width,
c=q.height;K.push([[-1,-1],[b+1,-1],[b+1,c+1],[-1,c+1]]);segments=VisibilityPolygon.convertToSegments(K);segments=VisibilityPolygon.breakIntersections(segments);for(b=0;b<E.length;++b)segments.push(E[b]);F=E.length}a.save()}else if(f){f=!1;G||(y&&(x(h-w,k),f=!0),z&&(x(h+w,k),f=!0),A&&(x(h,k-w),f=!0),B&&(x(h,k+w),f=!0));H&&(y||z||A||B)&&(G=!0);var b=n/2,c=p/2,e=b-h,r=c-k,l=Math.min(n,p)/2;a.restore();a.save();a.clearRect(0,0,n,p);v&&(a.beginPath(),a.arc(b,c,l,0,2*Math.PI,!0),a.clip());var d=VisibilityPolygon.computeViewport([h,
k],segments,[-e,-r],[n-e,p-r]);a.beginPath();a.moveTo(d[0][0]+e,d[0][1]+r);for(var g=1;g<d.length;++g)a.lineTo(d[g][0]+e,d[g][1]+r);a.clip();var d=h-n/2,g=k-p/2,t=n,u=p,m=b-n/2,C=c-p/2;v&&(d=h-l,g=k-l,t=2*l,u=2*l,m=b-l,C=c-l);0>d&&(m-=d,t+=d,d=0);0>g&&(C-=g,u+=g,g=0);d+t>=q.width&&(t=q.width-d-1);g+u>=q.height&&(u=q.height-g-1);a.drawImage(q,d,g,t,u,m,C,t,u);for(d=segments.length-F;d<segments.length;++d)a.beginPath(),a.lineWidth=10,a.strokeStyle="black",a.moveTo(segments[d][0][0]+e,segments[d][0][1]+
r),a.lineTo(segments[d][1][0]+e,segments[d][1][1]+r),a.stroke(),a.beginPath(),a.lineWidth=6,a.strokeStyle="white",a.moveTo(segments[d][0][0]+e,segments[d][0][1]+r),a.lineTo(segments[d][1][0]+e,segments[d][1][1]+r),a.stroke();a.beginPath();a.lineWidth=2;a.strokeStyle="black";a.fillStyle="white";a.fillRect(b-2,c-25,4,20);a.rect(b-2,c-25,4,20);a.stroke();a.fillRect(b-2,c+5,4,20);a.rect(b-2,c+5,4,20);a.stroke();a.fillRect(b-25,c-2,20,4);a.rect(b-25,c-2,20,4);a.stroke();a.fillRect(b+5,c-2,20,4);a.rect(b+
5,c-2,20,4);a.stroke();v&&(e=a.createRadialGradient(b,c,10,b,c,l),e.addColorStop(0,"rgba(0,0,0,0)"),e.addColorStop(.7,"rgba(0,0,0,0)"),e.addColorStop(1,"rgba(0,0,0,1)"),a.fillStyle=e,a.fillRect(b-l,c-l,2*l,2*l))}requestAnimFrame(P)}v="undefined"!==typeof v?v:!0;var n=window.innerWidth,p=window.innerHeight;canvas.getContext("2d").canvas.width=n;canvas.getContext("2d").canvas.height=p;var f=!0,F=0,Q=!1,h=m[0],k=m[1],y=!1,z=!1,A=!1,B=!1,H=!1,G=!1,S=0,T=0,I=0,J=0,w=5;m=new Hammer(document.getElementById("canvas"));
m.get("pan").set({direction:Hammer.DIRECTION_ALL});var q=new Image,R=!1;q.onload=function(){R=!0};q.src=D;requestAnimFrame(P);window.onresize=function(a){n=window.innerWidth;p=window.innerHeight;canvas.getContext("2d").canvas.width=n;canvas.getContext("2d").canvas.height=p;f=!0};document.addEventListener("touchmove",function(a){a.preventDefault()},!1);document.onkeydown=function(a){L(a.keyCode)?f=A=!0:M(a.keyCode)?f=y=!0:N(a.keyCode)?f=z=!0:O(a.keyCode)?f=B=!0:16==a.keyCode&&(H=!0)};document.onkeyup=
function(a){L(a.keyCode)?(A=!1,f=!0):M(a.keyCode)?(y=!1,f=!0):N(a.keyCode)?(z=!1,f=!0):O(a.keyCode)?(B=!1,f=!0):32==a.keyCode?console.log("["+Math.round(h)+","+Math.round(k)+"],"):191==a.keyCode||96==a.keyCode?w=Number(prompt("Enter movement speed:",w)):16==a.keyCode&&(H=!1);G=!1};m.on("pan",function(a){var b=a.center.x,c=a.center.y,e=a.deltaX;a=a.deltaY;b-=e;c-=a;if(b!=S||c!=T)J=I=0;S=b;T=c;b=e;c=a;e-=I;a-=J;I=b;J=c;x(h-e,k-a)})};
