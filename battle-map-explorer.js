/*
battle-map-explorer version 1.1

This code is released into the public domain - attribution is appreciated but not required.
Made by Byron Knoll.

https://github.com/byronknoll/battle-map-explorer
*/

window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(r,f){window.setTimeout(r,1E3/60)}}();function BattleMapExplorer(){}
BattleMapExplorer.run=function(r,f,I,D,x){function J(a){return 87==a||38==a||104==a?!0:!1}function K(a){return 65==a||37==a||100==a?!0:!1}function L(a){return 68==a||39==a||102==a?!0:!1}function M(a){return 83==a||40==a||98==a?!0:!1}function y(a,b){for(var c=0;c<segments.length-E;++c)if(VisibilityPolygon.doLineSegmentsIntersect(k,l,a,b,segments[c][0][0],segments[c][0][1],segments[c][1][0],segments[c][1][1]))return;k=a;l=b;e=!0}function N(){var a=canvas.getContext("2d");if(!O){if(P){O=!0;var b=p.width,
c=p.height;I.push([[-1,-1],[b+1,-1],[b+1,c+1],[-1,c+1]]);segments=VisibilityPolygon.convertToSegments(I);segments=VisibilityPolygon.breakIntersections(segments);for(b=0;b<D.length;++b)segments.push(D[b]);E=D.length}a.save()}else if(e){e=!1;F||(z&&(y(k-u,l),e=!0),A&&(y(k+u,l),e=!0),B&&(y(k,l-u),e=!0),C&&(y(k,l+u),e=!0));G&&(z||A||B||C)&&(F=!0);var b=m/2,c=n/2,v=Math.min(m,n)/2;a.restore();a.save();a.clearRect(0,0,m,n);x&&(a.beginPath(),a.arc(b,c,v,0,2*Math.PI,!0),a.clip());var g=b-k,q=c-l,h=VisibilityPolygon.computeViewport([k,
l],segments,[-g,-q],[m-g,n-q]);a.beginPath();a.moveTo(h[0][0]+g,h[0][1]+q);for(var d=1;d<h.length;++d)a.lineTo(h[d][0]+g,h[d][1]+q);a.clip();var h=k-m/2,d=l-n/2,f=m,w=n,r=b-m/2,t=c-n/2;0>h&&(r-=h,f+=h,h=0);0>d&&(t-=d,w+=d,d=0);h+f>=p.width&&(f=p.width-h-1);d+w>=p.height&&(w=p.height-d-1);a.drawImage(p,h,d,f,w,r,t,f,w);for(d=segments.length-E;d<segments.length;++d)a.beginPath(),a.lineWidth=10,a.strokeStyle="black",a.moveTo(segments[d][0][0]+g,segments[d][0][1]+q),a.lineTo(segments[d][1][0]+g,segments[d][1][1]+
q),a.stroke(),a.beginPath(),a.lineWidth=6,a.strokeStyle="white",a.moveTo(segments[d][0][0]+g,segments[d][0][1]+q),a.lineTo(segments[d][1][0]+g,segments[d][1][1]+q),a.stroke();a.beginPath();a.lineWidth=2;a.strokeStyle="black";a.fillStyle="white";a.fillRect(b-2,c-25,4,20);a.rect(b-2,c-25,4,20);a.stroke();a.fillRect(b-2,c+5,4,20);a.rect(b-2,c+5,4,20);a.stroke();a.fillRect(b-25,c-2,20,4);a.rect(b-25,c-2,20,4);a.stroke();a.fillRect(b+5,c-2,20,4);a.rect(b+5,c-2,20,4);a.stroke();x&&(g=a.createRadialGradient(b,
c,10,b,c,v),g.addColorStop(0,"rgba(0,0,0,0)"),g.addColorStop(.7,"rgba(0,0,0,0)"),g.addColorStop(1,"rgba(0,0,0,1)"),a.fillStyle=g,a.fillRect(b-v,c-v,2*v,2*v))}requestAnimFrame(N)}x="undefined"!==typeof x?x:!0;var m=window.innerWidth,n=window.innerHeight;canvas.getContext("2d").canvas.width=m;canvas.getContext("2d").canvas.height=n;var e=!0,E=0,O=!1,k=f[0],l=f[1],z=!1,A=!1,B=!1,C=!1,G=!1,F=!1,Q=0,R=0,t=0,H=0;f=new Hammer(document.getElementById("canvas"));f.get("pan").set({direction:Hammer.DIRECTION_ALL});
var u=5,p=new Image,P=!1;p.onload=function(){P=!0};p.src=r;requestAnimFrame(N);window.onresize=function(a){m=window.innerWidth;n=window.innerHeight;canvas.getContext("2d").canvas.width=m;canvas.getContext("2d").canvas.height=n;e=!0};document.addEventListener("touchmove",function(a){a.preventDefault()},!1);document.onkeydown=function(a){J(a.keyCode)?e=B=!0:K(a.keyCode)?e=z=!0:L(a.keyCode)?e=A=!0:M(a.keyCode)?e=C=!0:16==a.keyCode&&(G=!0)};document.onkeyup=function(a){J(a.keyCode)?(B=!1,e=!0):K(a.keyCode)?
(z=!1,e=!0):L(a.keyCode)?(A=!1,e=!0):M(a.keyCode)?(C=!1,e=!0):32==a.keyCode?console.log("["+Math.round(k)+","+Math.round(l)+"],"):191==a.keyCode||96==a.keyCode?u=Number(prompt("Enter movement speed:",u)):16==a.keyCode&&(G=!1);F=!1};f.on("pan",function(a){var b=a.center.x,c=a.center.y,e=a.deltaX;a=a.deltaY;b-=e;c-=a;if(b!=Q||c!=R)H=t=0;Q=b;R=c;b=e;c=a;e-=t;a-=H;t=b;H=c;y(k-e,l-a)})};
